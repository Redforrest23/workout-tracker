<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1f1f1f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Workout">
    <title>Workout Tracker</title>

    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='180' height='180' viewBox='0 0 180 180'><rect width='180' height='180' fill='%231f1f1f'/><text x='50%' y='50%' font-size='80' text-anchor='middle' dominant-baseline='middle' fill='%23bb86fc'>ðŸ’ª</text></svg>">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #121212;
            color: #fff;
            overflow-x: hidden;
        }

        /* Auth Screen Styles */
        .auth-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .auth-container {
            background-color: #1e1e1e;
            border-radius: 12px;
            padding: 30px;
            width: 100%;
            max-width: 400px;
            border: 1px solid #333;
        }

        .auth-title {
            font-size: 28px;
            font-weight: bold;
            color: #bb86fc;
            margin-bottom: 10px;
            text-align: center;
        }

        .auth-subtitle {
            font-size: 14px;
            color: #ccc;
            margin-bottom: 30px;
            text-align: center;
        }

        .auth-input {
            width: 100%;
            background-color: #2a2a2a;
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
            border: 1px solid #444;
            margin-bottom: 15px;
        }

        .auth-input:focus {
            outline: none;
            border-color: #bb86fc;
        }

        .auth-btn {
            width: 100%;
            background-color: #03dac6;
            padding: 15px;
            border-radius: 8px;
            border: none;
            color: #000;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .auth-btn:active {
            opacity: 0.8;
        }

        .auth-btn:disabled {
            background-color: #333;
            color: #666;
            cursor: not-allowed;
        }

        .auth-btn-secondary {
            background-color: #333;
            color: #fff;
        }

        .auth-error {
            color: #cf6679;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }

        .auth-success {
            color: #03dac6;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }

        .auth-link {
            color: #bb86fc;
            text-decoration: none;
            font-size: 14px;
            text-align: center;
            display: block;
            margin-top: 15px;
            cursor: pointer;
        }

        .loading-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-size: 18px;
            color: #bb86fc;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background-color: #1f1f1f;
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #333;
        }

        .header-title {
            font-size: 24px;
            font-weight: bold;
            color: #bb86fc;
        }

        .header-date {
            font-size: 14px;
            color: #ccc;
            margin-top: 5px;
        }

        .user-email {
            font-size: 12px;
            color: #888;
            margin-top: 3px;
        }

        .streak {
            font-size: 16px;
            color: #03dac6;
            margin-top: 5px;
            font-weight: 600;
        }

        .refresh-btn {
            background-color: #333;
            border-radius: 25px;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: none;
            cursor: pointer;
            font-size: 24px;
            color: #bb86fc;
            margin: 10px auto 0;
        }

        .button-row {
            display: flex;
            justify-content: space-around;
            padding: 10px;
            background-color: #1a1a1a;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            color: #fff;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            flex: 1;
        }

        .settings-btn {
            background-color: #333;
        }

        .history-btn {
            background-color: #444;
        }

        .postpone-btn {
            background-color: #bb86fc;
            color: #000;
        }

        .logout-btn {
            background-color: #cf6679;
            color: #fff;
        }

        .workout-list {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 20px;
        }

        .card {
            background-color: #1e1e1e;
            margin: 10px;
            border-radius: 12px;
            padding: 15px;
            border: 1px solid #333;
        }

        .completed-card {
            opacity: 0.7;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .ex-info {
            flex: 1;
        }

        .ex-name {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
        }

        .ex-cat {
            font-size: 12px;
            color: #bb86fc;
            margin-top: 2px;
        }

        .header-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        .diff-toggle {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .diff-label {
            font-size: 12px;
            color: #666;
        }

        .diff-label-active {
            color: #fff;
            font-weight: bold;
        }

        .toggle-switch {
            width: 40px;
            height: 20px;
            background-color: #03dac6;
            border-radius: 10px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .toggle-switch.hard {
            background-color: #cf6679;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: #fff;
            top: 2px;
            left: 2px;
            transition: left 0.3s;
        }

        .toggle-switch.hard::after {
            left: 22px;
        }

        .desc-btn {
            background-color: #333;
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            color: #03dac6;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .reg-section {
            background-color: #1a1a1a;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .hard-section {
            background-color: #2a1a1a;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #cf6679;
        }

        .diff-title {
            font-size: 14px;
            font-weight: 600;
            color: #03dac6;
            margin-bottom: 10px;
        }

        .diff-title-hard {
            font-size: 14px;
            font-weight: 600;
            color: #cf6679;
            margin-bottom: 10px;
        }

        .set-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 10px;
        }

        .set-label {
            font-size: 14px;
            color: #ccc;
            width: 60px;
        }

        .input {
            flex: 1;
            background-color: #2a2a2a;
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            border: 1px solid #444;
        }

        .completed-set-value {
            flex: 1;
            color: #03dac6;
            font-size: 14px;
            font-weight: 600;
        }

        .complete-btn {
            background-color: #03dac6;
            padding: 12px;
            border-radius: 8px;
            border: none;
            color: #000;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
        }

        .complete-btn:disabled {
            background-color: #333;
            opacity: 0.5;
            color: #666;
            cursor: not-allowed;
        }

        .completed-divider {
            background-color: #2a2a2a;
            padding: 12px 15px;
            margin: 20px 10px 0;
            border-radius: 8px;
        }

        .completed-title {
            font-size: 18px;
            font-weight: bold;
            color: #03dac6;
            text-align: center;
        }

        .completed-text {
            color: #03dac6;
        }

        .completed-summary {
            font-size: 14px;
            color: #aaa;
            margin-top: 5px;
            text-align: center;
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            padding: 5px 0;
        }

        .category-title-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .category-arrow {
            font-size: 16px;
            transition: transform 0.3s;
        }

        .category-arrow.collapsed {
            transform: rotate(-90deg);
        }

        .toggle-all-btn {
            background-color: #444;
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            color: #03dac6;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .category-exercises {
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .category-exercises.collapsed {
            max-height: 0;
        }

        .rest-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 30px;
        }

        .rest-title {
            font-size: 28px;
            font-weight: bold;
            color: #03dac6;
            margin-bottom: 15px;
            text-align: center;
        }

        .rest-text {
            font-size: 16px;
            color: #ccc;
            text-align: center;
            line-height: 24px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background-color: #1e1e1e;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            border: 1px solid #444;
            display: flex;
            flex-direction: column;
        }

        .modal-full {
            width: 90%;
            height: 80vh;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #333;
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #bb86fc;
        }

        .modal-done {
            font-size: 16px;
            color: #03dac6;
            font-weight: 600;
            background: none;
            border: none;
            cursor: pointer;
        }

        .modal-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #333;
            background-color: #1a1a1a;
        }

        .tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            color: #888;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .tab.active {
            color: #bb86fc;
            border-bottom-color: #bb86fc;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .desc-modal-content {
            background-color: #1e1e1e;
            border-radius: 12px;
            padding: 20px;
            width: 85%;
            max-height: 70vh;
            border: 1px solid #444;
            overflow-y: auto;
        }

        .desc-title {
            font-size: 20px;
            font-weight: bold;
            color: #bb86fc;
            margin-bottom: 15px;
        }

        .desc-text {
            font-size: 14px;
            color: #ccc;
            line-height: 20px;
            margin-bottom: 15px;
        }

        .video-link-btn {
            background-color: #bb86fc;
            padding: 12px;
            border-radius: 8px;
            border: none;
            color: #000;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 15px;
        }

        .pdf-info-box {
            background-color: #2a2a2a;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #444;
        }

        .pdf-info-text {
            font-size: 14px;
            color: #03dac6;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .pdf-page-text {
            font-size: 13px;
            color: #fff;
            font-style: italic;
        }

        .pdf-link-btn {
            background-color: #03dac6;
            padding: 12px;
            border-radius: 8px;
            border: none;
            color: #000;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 15px;
        }

        .close-btn {
            background-color: #333;
            padding: 12px;
            border-radius: 8px;
            border: none;
            color: #fff;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            width: 100%;
        }

        .cat-title {
            font-size: 16px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 10px;
            margin-top: 20px;
        }

        .cat-title:first-child {
            margin-top: 0;
        }

        .settings-subtitle {
            font-size: 12px;
            color: #888;
            margin-bottom: 10px;
            font-style: italic;
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #2a2a2a;
        }

        .settings-name {
            font-size: 14px;
            color: #ccc;
            flex: 1;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .rest-day-selector {
            background-color: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .rest-day-label {
            font-size: 14px;
            color: #ccc;
            margin-bottom: 10px;
        }

        .rest-day-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .rest-day-option {
            background-color: #333;
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid #444;
            color: #ccc;
            font-size: 14px;
            cursor: pointer;
        }

        .rest-day-option.selected {
            background-color: #bb86fc;
            color: #000;
            border-color: #bb86fc;
        }

        .info-section {
            background-color: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .info-title {
            font-size: 16px;
            font-weight: bold;
            color: #bb86fc;
            margin-bottom: 8px;
        }

        .info-text {
            font-size: 14px;
            color: #ccc;
            line-height: 20px;
        }

        .empty-history {
            font-size: 14px;
            color: #888;
            text-align: center;
            margin-top: 30px;
        }

        .history-card {
            background-color: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #444;
            cursor: pointer;
        }

        .history-date {
            font-size: 16px;
            font-weight: bold;
            color: #03dac6;
            margin-bottom: 5px;
        }

        .history-type {
            font-size: 14px;
            color: #bb86fc;
            margin-bottom: 8px;
        }

        .history-exercises {
            font-size: 12px;
            color: #aaa;
            margin-bottom: 5px;
        }

        .tap-to-view {
            font-size: 11px;
            color: #666;
            font-style: italic;
            margin-top: 5px;
        }

        @media (max-width: 600px) {
            .header-title {
                font-size: 20px;
            }

            .card {
                margin: 10px 5px;
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Initialize Supabase client
        const SUPABASE_URL = 'https://gnxwcdwqmderpghmtddy.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdueHdjZHdxbWRlcnBnaG10ZGR5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0NTQwODcsImV4cCI6MjA3NzAzMDA4N30.NCxKQvkvAuRlaAWR9FdYR9Or15qYyG2V69H-EeJU7pA';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const DEFAULT_EXERCISES = {
            push: [
                { id: 'p1', name: 'Wall Push-ups', difficulty: 1, sets: 3, reps: 10, hardSets: 4, hardReps: 15, isTime: false, enabled: true, desc: 'Stand facing wall. Hands on wall at shoulder height. Lean in, push back. Keep body straight throughout.', videoUrl: 'https://www.hybridcalisthenics.com/wall-pushups' },
                { id: 'p2', name: 'Incline Push-ups', difficulty: 2, sets: 3, reps: 10, hardSets: 4, hardReps: 12, isTime: false, enabled: false, desc: 'Hands on elevated surface. Lower chest to surface, push up. Keep core tight, body in straight line.', videoUrl: 'https://www.hybridcalisthenics.com/incline-pushups' },
                { id: 'p3', name: 'Regular Push-ups', difficulty: 3, sets: 3, reps: 10, hardSets: 4, hardReps: 15, isTime: false, enabled: false, desc: 'Plank position. Lower chest to ground, elbows 45Â°. Push back up. Maintain straight body line.', videoUrl: 'https://www.hybridcalisthenics.com/full-pushups' },
                { id: 'p4', name: 'Diamond Push-ups', difficulty: 4, sets: 3, reps: 8, hardSets: 3, hardReps: 12, isTime: false, enabled: false, desc: 'Thumbs and index fingers form diamond. Keep elbows close. Targets triceps heavily.', videoUrl: null },
                { id: 'p5', name: 'Decline Push-ups', difficulty: 5, sets: 3, reps: 10, hardSets: 4, hardReps: 12, isTime: false, enabled: false, desc: 'Feet elevated. Hands on ground. Harder than regular push-ups. Emphasizes upper chest.', videoUrl: null },
                { id: 'p6', name: 'Archer Push-ups', difficulty: 6, sets: 3, reps: 6, hardSets: 3, hardReps: 10, isTime: false, enabled: false, desc: 'Wide hands. Lower to one side, other arm extends. Alternate sides. Advanced strength.', videoUrl: 'https://www.hybridcalisthenics.com/pushups' },
                { id: 'p7', name: 'One-Arm Push-up Progression', difficulty: 7, sets: 3, reps: 5, hardSets: 3, hardReps: 8, isTime: false, enabled: false, desc: 'Progress toward one-arm. Start wide stance. Gradually narrow. Ultimate push variation.', videoUrl: 'https://www.hybridcalisthenics.com/pushups' }
            ],
            pull: [
                { id: 'pu1', name: 'Wall Pull-ups', difficulty: 1, sets: 3, reps: 8, hardSets: 3, hardReps: 12, isTime: false, enabled: true, desc: 'Face wall, hands overhead. Walk feet forward, lean back. Pull toward wall using back.', videoUrl: null },
                { id: 'pu2', name: 'Australian Pull-ups', difficulty: 2, sets: 3, reps: 8, hardSets: 4, hardReps: 12, isTime: false, enabled: false, desc: 'Low bar. Hang underneath, body straight. Pull chest to bar. Lower with control.', videoUrl: 'https://www.hybridcalisthenics.com/pullups' },
                { id: 'pu3', name: 'Negative Pull-ups', difficulty: 3, sets: 3, reps: 5, hardSets: 3, hardReps: 8, isTime: false, enabled: false, desc: 'Jump to top position. Lower slowly (5-10 seconds). Builds strength for full pull-ups.', videoUrl: 'https://www.hybridcalisthenics.com/pullups' },
                { id: 'pu4', name: 'Assisted Pull-ups', difficulty: 4, sets: 3, reps: 6, hardSets: 3, hardReps: 10, isTime: false, enabled: false, desc: 'Use band or chair for assistance. Pull chin over bar. Focus on back muscles.', videoUrl: 'https://www.hybridcalisthenics.com/pullups' },
                { id: 'pu5', name: 'Regular Pull-ups', difficulty: 5, sets: 3, reps: 5, hardSets: 4, hardReps: 8, isTime: false, enabled: false, desc: 'Hang from bar, palms away. Pull chin over bar. Lower controlled. Engage core.', videoUrl: 'https://www.hybridcalisthenics.com/pullups' },
                { id: 'pu6', name: 'Chin-ups', difficulty: 5, sets: 3, reps: 6, hardSets: 4, hardReps: 10, isTime: false, enabled: false, desc: 'Palms facing you. Slightly easier. More bicep involvement. Pull chin over bar.', videoUrl: 'https://www.hybridcalisthenics.com/pullups' },
                { id: 'pu7', name: 'Wide Grip Pull-ups', difficulty: 6, sets: 3, reps: 5, hardSets: 3, hardReps: 8, isTime: false, enabled: false, desc: 'Hands wider than shoulders. Targets lats more. Harder than regular pull-ups.', videoUrl: 'https://www.hybridcalisthenics.com/pullups' },
                { id: 'pu8', name: 'Archer Pull-ups', difficulty: 7, sets: 3, reps: 4, hardSets: 3, hardReps: 6, isTime: false, enabled: false, desc: 'Pull to one hand, other extends. Very advanced. Builds one-arm pulling strength.', videoUrl: 'https://www.hybridcalisthenics.com/pullups' }
            ],
            squats: [
                { id: 'sq1', name: 'Assisted Squats', difficulty: 1, sets: 3, reps: 12, hardSets: 4, hardReps: 15, isTime: false, enabled: true, desc: 'Hold chair or wall. Squat down low as comfortable. Stand back up. Build strength.', videoUrl: 'https://www.hybridcalisthenics.com/squats' },
                { id: 'sq2', name: 'Regular Squats', difficulty: 2, sets: 3, reps: 15, hardSets: 4, hardReps: 20, isTime: false, enabled: false, desc: 'Feet shoulder-width. Lower hips back and down. Chest up. Knees track over toes.', videoUrl: 'https://www.hybridcalisthenics.com/squats' },
                { id: 'sq3', name: 'Close Stance Squats', difficulty: 3, sets: 3, reps: 12, hardSets: 4, hardReps: 15, isTime: false, enabled: false, desc: 'Feet close together. More balance challenge. Increased quad emphasis.', videoUrl: null },
                { id: 'sq4', name: 'Bulgarian Split Squats', difficulty: 4, sets: 3, reps: 10, hardSets: 3, hardReps: 12, isTime: false, enabled: false, desc: 'Back foot elevated. Front foot forward. Lower into lunge. Single-leg strength.', videoUrl: null },
                { id: 'sq5', name: 'Jump Squats', difficulty: 4, sets: 3, reps: 10, hardSets: 3, hardReps: 15, isTime: false, enabled: false, desc: 'Squat down, explode into jump. Land soft. Builds power and explosiveness.', videoUrl: null },
                { id: 'sq6', name: 'Assisted Pistol Squat', difficulty: 5, sets: 3, reps: 6, hardSets: 3, hardReps: 8, isTime: false, enabled: false, desc: 'One-leg with support. Other leg extended forward. Progress toward full pistol.', videoUrl: 'https://www.hybridcalisthenics.com/squats' },
                { id: 'sq7', name: 'Pistol Squats', difficulty: 6, sets: 3, reps: 5, hardSets: 3, hardReps: 8, isTime: false, enabled: false, desc: 'One leg, other extended. Squat on standing leg. Very challenging movement.', videoUrl: 'https://www.hybridcalisthenics.com/squats' },
                { id: 'sq8', name: 'Dragon Squats', difficulty: 7, sets: 3, reps: 20, hardSets: 3, hardReps: 30, isTime: true, enabled: false, desc: 'Deep squat on one leg, other extended to side. Hold. Advanced mobility and strength.', videoUrl: null }
            ],
            core: [
                { id: 'c1', name: 'Knee Raises', difficulty: 1, sets: 3, reps: 10, hardSets: 4, hardReps: 12, isTime: false, enabled: true, desc: 'Lie on back or hang. Bring knees to chest. Lower controlled. Beginner core.', videoUrl: null },
                { id: 'c2', name: 'Dead Bugs', difficulty: 2, sets: 3, reps: 10, hardSets: 3, hardReps: 15, isTime: false, enabled: false, desc: 'Back on ground. Extend opposite arm and leg. Alternate. Keep lower back pressed down.', videoUrl: null },
                { id: 'c3', name: 'Leg Raises', difficulty: 3, sets: 3, reps: 8, hardSets: 3, hardReps: 12, isTime: false, enabled: false, desc: 'Lie flat. Raise straight legs to 90Â°. Lower slowly. Don\'t let back arch.', videoUrl: null },
                { id: 'c4', name: 'Hanging Knee Raises', difficulty: 4, sets: 3, reps: 8, hardSets: 3, hardReps: 12, isTime: false, enabled: false, desc: 'Hang from bar. Bring knees to chest. Lower slow. Avoid swinging.', videoUrl: null },
                { id: 'c5', name: 'Hanging Leg Raises', difficulty: 5, sets: 3, reps: 6, hardSets: 3, hardReps: 10, isTime: false, enabled: false, desc: 'Hang from bar. Raise straight legs horizontal. Advanced core strength required.', videoUrl: null }
            ],
            mandatory: [
                { id: 'm1', name: 'Elephant Walks', sets: 2, reps: 10, hardSets: 3, hardReps: 15, isTime: false, enabled: true, desc: 'Stand, bend forward to touch toes. Alternate bending knees, lifting heels. Dynamic hamstring stretch. Prepares body for deeper stretching.', videoUrl: 'https://www.youtube.com/shorts/jDFH__6aRGQ' },
                { id: 'm2', name: 'Single Leg RDL', sets: 2, reps: 8, hardSets: 3, hardReps: 12, isTime: false, enabled: true, desc: 'Stand on one leg. Hinge at hip, reach down with opposite hand. Keep back straight. Other leg extends behind for balance. Hamstring and balance work.', videoUrl: 'https://www.youtube.com/shorts/jDFH__6aRGQ' },
                { id: 'm3', name: 'Pike Pull Stretch', sets: 2, reps: 30, hardSets: 3, hardReps: 45, isTime: true, enabled: true, desc: 'Sit or stand in pike position. Grab something stable (bar, pole, bench). Pull your head toward your feet. Deep hamstring and back stretch.', videoUrl: 'https://www.youtube.com/shorts/jDFH__6aRGQ' }
            ],
            apt: [
                { id: 'a1', name: 'Glute Bridges', sets: 3, reps: 12, hardSets: 4, hardReps: 15, isTime: false, enabled: true, desc: 'Lie on back, knees bent. Lift hips by squeezing glutes until straight line. Lower slow. Use glutes, not back.', videoUrl: null },
                { id: 'a2', name: 'Dead Bugs', sets: 3, reps: 10, hardSets: 3, hardReps: 15, isTime: false, enabled: true, desc: 'Back flat, arms up, knees 90Â°. Extend opposite limbs. Maintain posterior pelvic tilt throughout.', videoUrl: null },
                { id: 'a3', name: 'Plank with PPT', sets: 3, reps: 30, hardSets: 3, hardReps: 45, isTime: true, enabled: true, desc: 'Plank position. Tuck tailbone, engage abs. Squeeze glutes. Lower back should round slightly.', videoUrl: null },
                { id: 'a4', name: 'Couch Stretch', sets: 2, reps: 30, hardSets: 3, hardReps: 45, isTime: true, enabled: true, desc: 'Back knee against wall, shin vertical. Front foot forward. Upright torso, squeeze glutes. Deep hip flexor stretch.', videoUrl: null },
                { id: 'a5', name: 'RDLs', sets: 3, reps: 10, hardSets: 3, hardReps: 12, isTime: false, enabled: true, desc: 'Hip-width stance. Hinge at hips, push back. Keep back straight. Feel hamstring stretch. Stand by squeezing glutes.', videoUrl: null },
                { id: 'a6', name: 'Cat-Cow', sets: 3, reps: 10, hardSets: 3, hardReps: 15, isTime: false, enabled: true, desc: 'Hands and knees. Cat: round spine, tuck tail. Cow: arch back, lift tail. Focus on tucked position for APT.', videoUrl: null },
                { id: 'a7', name: 'Clamshells', sets: 3, reps: 15, hardSets: 4, hardReps: 20, isTime: false, enabled: true, desc: 'Side-lying, knees 90Â°. Keep feet touching, lift top knee. Lower slow. Works glutes and hip rotators.', videoUrl: null },
                { id: 'a8', name: 'Reverse Plank', sets: 3, reps: 20, hardSets: 3, hardReps: 30, isTime: true, enabled: true, desc: 'Sit, legs extended, hands behind. Lift hips straight. Squeeze glutes hard. Maintain posterior pelvic tilt.', videoUrl: null },
                { id: 'a9', name: 'Wall Pelvic Tilts', sets: 3, reps: 10, hardSets: 3, hardReps: 15, isTime: false, enabled: true, desc: 'Back against wall, feet forward. Press lower back flat to wall (posterior tilt). Release. Teaches movement pattern.', videoUrl: null },
                { id: 'a10', name: '90/90 Hip Lift', sets: 3, reps: 8, hardSets: 3, hardReps: 12, isTime: false, enabled: true, desc: 'Back on ground, feet on wall at 90Â°. Press back down, exhale fully, lift hips slightly. Advanced core control.', videoUrl: null },
                { id: 'a11', name: 'Band Hip Extension', sets: 3, reps: 12, hardSets: 3, hardReps: 15, isTime: false, enabled: true, desc: 'Band on ankle. Extend hip back by squeezing glute. Keep knee straight. Don\'t arch back.', videoUrl: null },
                { id: 'a12', name: 'Bird Dogs', sets: 3, reps: 10, hardSets: 3, hardReps: 12, isTime: false, enabled: true, desc: 'Hands and knees. Extend opposite arm and leg. Hold briefly. Keep hips level. Stability and control.', videoUrl: null },
                { id: 'a13', name: 'Pelvic Clock', sets: 2, reps: 8, hardSets: 3, hardReps: 10, isTime: false, enabled: true, desc: 'Lie on back, knees bent. Imagine clock on pelvis. Tilt through each hour. 12:00 is posterior tilt.', videoUrl: null },
                { id: 'a14', name: 'Side Plank', sets: 3, reps: 20, hardSets: 3, hardReps: 30, isTime: true, enabled: true, desc: 'Side-lying on elbow. Lift hips straight. Hold. Keep hips stacked. Optional: lift top leg.', videoUrl: null },
                { id: 'a15', name: 'Frog Stretch', sets: 2, reps: 45, hardSets: 3, hardReps: 60, isTime: true, enabled: true, desc: 'Hands and knees, spread knees wide. Push hips back, lower down. Opens hips, stretches adductors.', videoUrl: null },
                { id: 'a16', name: 'World\'s Greatest', sets: 2, reps: 5, hardSets: 3, hardReps: 8, isTime: false, enabled: true, desc: 'Lunge. Hands inside front foot. Drop elbow down. Rotate and reach up. Full-body mobility.', videoUrl: null },
                { id: 'a17', name: 'Band Hip Distraction', sets: 2, reps: 30, hardSets: 3, hardReps: 45, isTime: true, enabled: true, desc: 'Band at hip crease. Half-kneeling. Band pulls hip back. Rock forward gently. Advanced technique.', videoUrl: null },
                { id: 'a18', name: 'Child\'s Pose PPT', sets: 2, reps: 45, hardSets: 3, hardReps: 60, isTime: true, enabled: true, desc: 'Sit on heels, arms forward. Tuck tailbone posteriorly. Gently round lower back. Breathe deep.', videoUrl: null }
            ],
            stretches: {
                hipFlexor: [
                    { id: 'sh1', name: 'Kneeling Hip Flexor', sets: 2, reps: 30, hardSets: 3, hardReps: 45, isTime: true, enabled: true, desc: 'Kneel on one knee. Keep upright. Push hips forward. Squeeze glute of kneeling leg.', videoUrl: null, pdfUrl: 'https://movementbydavid.com/wp-content/uploads/2025/02/FS-Hips-V2.pdf', pdfPage: 'Week 2 Day 2' },
                    { id: 'sh2', name: 'Couch Stretch', sets: 2, reps: 30, hardSets: 3, hardReps: 45, isTime: true, enabled: true, desc: 'Knee against wall. Shin vertical. Front foot forward. Upright torso. Squeeze glutes.', videoUrl: null, pdfUrl: 'https://movementbydavid.com/wp-content/uploads/2025/02/FS-Hips-V2.pdf', pdfPage: 'Week 4 Day 1' },
                    { id: 'sh3', name: 'Frog Stretch', sets: 2, reps: 45, hardSets: 3, hardReps: 60, isTime: true, enabled: true, desc: 'Knees wide. Push hips back. Lower toward ground. Opens hips and adductors.', videoUrl: null, pdfUrl: null, pdfPage: null }
                ],
                hamstring: [
                    { id: 'sh4', name: 'Standing Hamstring', sets: 2, reps: 30, hardSets: 3, hardReps: 45, isTime: true, enabled: true, desc: 'Heel forward on elevated surface. Straight leg. Hinge at hips. Reach toward toes.', videoUrl: null, pdfUrl: 'https://movementbydavid.com/wp-content/uploads/2025/02/FS-Hamstring-V2.pdf', pdfPage: 'Week 3 Day 3' },
                    { id: 'sh5', name: 'Seated Hamstring', sets: 2, reps: 30, hardSets: 3, hardReps: 45, isTime: true, enabled: true, desc: 'Sit, legs extended. Hinge at hips. Reach forward. Keep back straight.', videoUrl: null, pdfUrl: 'https://movementbydavid.com/wp-content/uploads/2025/02/FS-Hamstring-V2.pdf', pdfPage: 'Week 1 Day 1' },
                    { id: 'sh6', name: 'Single-Leg Hamstring', sets: 2, reps: 30, hardSets: 3, hardReps: 45, isTime: true, enabled: true, desc: 'Sit with one leg extended. Other bent. Reach toward extended leg.', videoUrl: null, pdfUrl: 'https://movementbydavid.com/wp-content/uploads/2025/02/FS-Hamstring-V2.pdf', pdfPage: 'Week 1 Day 1' }
                ],
                hipGlute: [
                    { id: 'sh7', name: 'Figure-4', sets: 2, reps: 30, hardSets: 3, hardReps: 45, isTime: true, enabled: true, desc: 'Lie on back. Cross ankle over knee. Pull thigh to chest. Stretches piriformis and glutes.', videoUrl: null, pdfUrl: 'https://movementbydavid.com/wp-content/uploads/2025/02/FS-Hips-V2.pdf', pdfPage: 'Week 3 Day 3' },
                    { id: 'sh8', name: 'Pigeon Pose', sets: 2, reps: 45, hardSets: 3, hardReps: 60, isTime: true, enabled: true, desc: 'Front leg bent 90Â°. Back leg extended. Lower hips down. Deep glute stretch.', videoUrl: null, pdfUrl: 'https://movementbydavid.com/wp-content/uploads/2025/02/FS-Hips-V2.pdf', pdfPage: 'Week 1 Day 1' },
                    { id: 'sh9', name: '90/90 Hip', sets: 2, reps: 30, hardSets: 3, hardReps: 45, isTime: true, enabled: true, desc: 'Both legs bent 90Â°. One internal, one external rotation. Lean forward. Hip mobility.', videoUrl: null, pdfUrl: 'https://movementbydavid.com/wp-content/uploads/2025/02/FS-Hips-V2.pdf', pdfPage: 'Week 1 Day 2' }
                ],
                shoulder: [
                    { id: 'sh10', name: 'Shoulder Dislocates', sets: 2, reps: 10, hardSets: 3, hardReps: 12, isTime: false, enabled: true, desc: 'Hold band wide. Straight arms. Bring overhead and behind back. Return. Mobility drill.', videoUrl: null, pdfUrl: 'https://movementbydavid.com/wp-content/uploads/2025/01/FS-Shoulders-V2.pdf', pdfPage: 'Week 3 Day 3' },
                    { id: 'sh11', name: 'Cross-Body Shoulder', sets: 2, reps: 20, hardSets: 3, hardReps: 30, isTime: true, enabled: true, desc: 'Pull arm across body. Keep shoulders down. Stretch back of shoulder.', videoUrl: null, pdfUrl: null, pdfPage: null },
                    { id: 'sh12', name: 'Wall Slides', sets: 2, reps: 10, hardSets: 3, hardReps: 15, isTime: false, enabled: true, desc: 'Back to wall. Arms in goal post. Slide up overhead. Keep contact with wall.', videoUrl: null, pdfUrl: 'https://movementbydavid.com/wp-content/uploads/2025/01/FS-Shoulders-V2.pdf', pdfPage: 'Week 4 Day 1' }
                ],
                backSpine: [
                    { id: 'sh13', name: 'Cat-Cow', sets: 2, reps: 10, hardSets: 3, hardReps: 15, isTime: false, enabled: true, desc: 'Hands and knees. Alternate arching (cow) and rounding (cat). Mobilizes spine.', videoUrl: null, pdfUrl: 'https://movementbydavid.com/wp-content/uploads/2025/02/FS-Spine-V2.pdf', pdfPage: 'Week 1 Day 1' },
                    { id: 'sh14', name: 'Child\'s Pose', sets: 2, reps: 45, hardSets: 3, hardReps: 60, isTime: true, enabled: true, desc: 'Sit on heels. Arms extended forward. Relax and breathe. Back and shoulder stretch.', videoUrl: null, pdfUrl: null, pdfPage: null },
                    { id: 'sh15', name: 'Cobra', sets: 2, reps: 30, hardSets: 3, hardReps: 45, isTime: true, enabled: true, desc: 'Face down. Push up through hands. Lift chest. Hips stay down. Extends spine.', videoUrl: null, pdfUrl: 'https://movementbydavid.com/wp-content/uploads/2025/02/FS-Spine-V2.pdf', pdfPage: 'Week 3 Day 2' }
                ],
                fullBody: [
                    { id: 'sh16', name: 'World\'s Greatest', sets: 2, reps: 5, hardSets: 3, hardReps: 8, isTime: false, enabled: true, desc: 'Lunge. Hands inside front foot. Elbow down. Rotate and reach up. Full mobility.', videoUrl: null, pdfUrl: null, pdfPage: null },
                    { id: 'sh17', name: 'Downward Dog', sets: 2, reps: 30, hardSets: 3, hardReps: 45, isTime: true, enabled: true, desc: 'Inverted V. Hands and feet down. Hips high. Push heels down. Full body stretch.', videoUrl: null, pdfUrl: null, pdfPage: null }
                ]
            }
        };

        const WEEK_SCHEDULE = {
            0: { name: 'Legs', focus: ['squats'], includeCore: false },
            1: { name: 'Push', focus: ['push'], includeCore: true },
            2: { name: 'Pull', focus: ['pull'], includeCore: false },
            3: { name: 'Legs', focus: ['squats'], includeCore: false },
            4: { name: 'Push', focus: ['push'], includeCore: true },
            5: { name: 'Pull', focus: ['pull'], includeCore: false },
            6: { name: 'Rest', focus: [], includeCore: false }
        };

        const DAYS_OF_WEEK = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

        // Auth Component
        function AuthScreen() {
            const [isSignUp, setIsSignUp] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState('');
            const [error, setError] = useState('');

            const handleSignUp = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                setMessage('');

                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                });

                setLoading(false);

                if (error) {
                    setError(error.message);
                } else {
                    setMessage('Check your email to confirm your account!');
                }
            };

            const handleSignIn = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                setMessage('');

                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password,
                });

                setLoading(false);

                if (error) {
                    setError(error.message);
                }
            };

            return (
                <div className="auth-screen">
                    <div className="auth-container">
                        <div className="auth-title">ðŸ’ª Workout Tracker</div>
                        <div className="auth-subtitle">
                            {isSignUp ? 'Create your account' : 'Sign in to your account'}
                        </div>

                        <form onSubmit={isSignUp ? handleSignUp : handleSignIn}>
                            <input
                                type="email"
                                className="auth-input"
                                placeholder="Email"
                                value={email}
                                onChange={(e) => setEmail(e.target.value)}
                                required
                                autoFocus
                            />
                            <input
                                type="password"
                                className="auth-input"
                                placeholder="Password (min 6 characters)"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                required
                                minLength={6}
                            />

                            <button type="submit" className="auth-btn" disabled={loading}>
                                {loading ? 'Loading...' : (isSignUp ? 'Sign Up' : 'Sign In')}
                            </button>
                        </form>

                        <button
                            className="auth-btn auth-btn-secondary"
                            onClick={() => {
                                setIsSignUp(!isSignUp);
                                setError('');
                                setMessage('');
                            }}
                        >
                            {isSignUp ? 'Already have an account? Sign In' : 'Need an account? Sign Up'}
                        </button>

                        {message && <div className="auth-success">{message}</div>}
                        {error && <div className="auth-error">{error}</div>}
                    </div>
                </div>
            );
        }
        // Main App Component
        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [exercises, setExercises] = useState(DEFAULT_EXERCISES);
            const [workout, setWorkout] = useState([]);
            const [completedWorkout, setCompletedWorkout] = useState([]);
            const [log, setLog] = useState({});
            const [hardMode, setHardMode] = useState({});
            const [showSettings, setShowSettings] = useState(false);
            const [activeSettingsTab, setActiveSettingsTab] = useState('exercises');
            const [showDesc, setShowDesc] = useState(false);
            const [showHistory, setShowHistory] = useState(false);
            const [selected, setSelected] = useState(null);
            const [date, setDate] = useState('');
            const [dayName, setDayName] = useState('');
            const [isRest, setIsRest] = useState(false);
            const [streak, setStreak] = useState(0);
            const [history, setHistory] = useState([]);
            const [lastStretchCats, setLastStretchCats] = useState([]);
            const [viewingHistoryWorkout, setViewingHistoryWorkout] = useState(null);
            const [showHistoryDetail, setShowHistoryDetail] = useState(false);
            const [workoutComplete, setWorkoutComplete] = useState(false);
            const [customRestDay, setCustomRestDay] = useState(6);
            const [restDayPostponed, setRestDayPostponed] = useState(false);
            const [collapsedCategories, setCollapsedCategories] = useState({});

            useEffect(() => {
                checkUser();

                const { data: authListener } = supabase.auth.onAuthStateChange((event, session) => {
                    setUser(session?.user ?? null);
                    if (session?.user) {
                        loadData(session.user.id);
                    }
                });

                return () => {
                    authListener.subscription.unsubscribe();
                };
            }, []);

            useEffect(() => {
                if (user) {
                    finishWorkout();
                }
            }, [workout, completedWorkout, user]);

            const checkUser = async () => {
                const { data: { session } } = await supabase.auth.getSession();
                setUser(session?.user ?? null);
                if (session?.user) {
                    await loadData(session.user.id);
                }
                setLoading(false);
            };

            const loadData = async (userId) => {
                try {
                    // Load exercise settings
                    const { data: settingsData } = await supabase
                        .from('exercise_settings')
                        .select('exercise_data')
                        .eq('user_id', userId)
                        .single();

                    if (settingsData) {
                        setExercises(settingsData.exercise_data);
                    }

                    // Load user profile (rest day)
                    const { data: profileData } = await supabase
                        .from('user_profiles')
                        .select('custom_rest_day')
                        .eq('id', userId)
                        .single();

                    let currentRestDay = 6;
                    if (profileData) {
                        currentRestDay = profileData.custom_rest_day;
                        setCustomRestDay(currentRestDay);
                    }

                    // Check for rest day postponement
                    const today = new Date().toDateString();
                    const { data: postponementData } = await supabase
                        .from('rest_day_postponements')
                        .select('*')
                        .eq('user_id', userId)
                        .eq('postponed_date', new Date().toISOString().split('T')[0])
                        .single();

                    const isPostponed = !!postponementData;
                    setRestDayPostponed(isPostponed);

                    // Load workout history
                    const { data: historyData } = await supabase
                        .from('workout_history')
                        .select('*')
                        .eq('user_id', userId)
                        .order('date', { ascending: false });

                    if (historyData) {
                        setHistory(historyData);
                        calculateStreak(historyData, currentRestDay);
                    }

                    // Load stretch categories
                    const { data: stretchData } = await supabase
                        .from('stretch_categories')
                        .select('last_categories')
                        .eq('user_id', userId)
                        .single();

                    let loadedStretchCats = [];
                    if (stretchData) {
                        loadedStretchCats = stretchData.last_categories;
                        setLastStretchCats(loadedStretchCats);
                    }

                    // Generate workout
                    const d = new Date();
                    const day = d.getDay();
                    setDate(d.toDateString());

                    let isRestDay;
                    if (isPostponed && day === currentRestDay) {
                        isRestDay = false;
                    } else {
                        isRestDay = day === currentRestDay;
                    }

                    setIsRest(isRestDay);

                    if (isRestDay) {
                        setDayName('Rest');
                    } else {
                        setDayName(WEEK_SCHEDULE[day].name);

                        const todayDateStr = d.toISOString().split('T')[0];
                        const alreadyWorkedOut = historyData?.some(h =>
                            new Date(h.date).toISOString().split('T')[0] === todayDateStr
                        );

                        if (!alreadyWorkedOut) {
                            generateWorkoutWithExercises(day, settingsData?.exercise_data || DEFAULT_EXERCISES, loadedStretchCats);
                        } else {
                            setWorkoutComplete(true);
                        }
                    }
                } catch (error) {
                    console.error('Error loading data:', error);
                }
            };

            const calculateStreak = (historyData, restDay) => {
                if (!historyData || historyData.length === 0) {
                    setStreak(0);
                    return;
                }

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                let currentStreak = 0;
                let checkDate = new Date(today);

                while (true) {
                    const dayOfWeek = checkDate.getDay();

                    if (dayOfWeek === restDay) {
                        checkDate.setDate(checkDate.getDate() - 1);
                        continue;
                    }

                    const dateStr = checkDate.toISOString().split('T')[0];
                    const workedOut = historyData.some(h =>
                        new Date(h.date).toISOString().split('T')[0] === dateStr
                    );

                    if (workedOut) {
                        currentStreak++;
                        checkDate.setDate(checkDate.getDate() - 1);
                    } else {
                        break;
                    }

                    if (currentStreak > 100) break;
                }

                setStreak(currentStreak);
            };

            const generateWorkout = (dayNum) => {
                generateWorkoutWithExercises(dayNum, exercises, lastStretchCats);
            };

            const generateWorkoutWithExercises = (dayNum, exercisesData, prevStretchCats) => {
                const schedule = WEEK_SCHEDULE[dayNum];
                const selected = [];

                if (dayNum === 1 || dayNum === 3 || dayNum === 5) {
                    const mandatoryEnabled = exercisesData.mandatory.filter(e => e.enabled);
                    for (const ex of mandatoryEnabled) {
                        selected.push({ ...ex, category: 'Mobility' });
                    }
                }

                for (const category of schedule.focus) {
                    const enabled = exercisesData[category].filter(e => e.enabled);
                    if (enabled.length > 0) {
                        selected.push({ ...enabled[0], category: schedule.name });
                    }
                }

                if (schedule.includeCore) {
                    const enabledCore = exercisesData.core.filter(e => e.enabled);
                    if (enabledCore.length > 0) {
                        selected.push({ ...enabledCore[0], category: 'Core' });
                    }
                }

                const aptEnabled = exercisesData.apt.filter(e => e.enabled);
                const numAPT = Math.floor(Math.random() * 2) + 2;
                const aptCopy = [...aptEnabled];
                for (let i = 0; i < Math.min(numAPT, aptCopy.length); i++) {
                    const idx = Math.floor(Math.random() * aptCopy.length);
                    selected.push({ ...aptCopy[idx], category: 'APT' });
                    aptCopy.splice(idx, 1);
                }

                const availableCats = Object.keys(exercisesData.stretches).filter(
                    cat => !prevStretchCats.includes(cat)
                );

                const stretchPool = [];
                for (const cat of availableCats) {
                    stretchPool.push(...exercisesData.stretches[cat].filter(e => e.enabled));
                }

                const numStretches = Math.floor(Math.random() * 2) + 2;
                const stretchCopy = [...stretchPool];
                const usedCats = [];

                for (let i = 0; i < Math.min(numStretches, stretchCopy.length); i++) {
                    const idx = Math.floor(Math.random() * stretchCopy.length);
                    const stretch = stretchCopy[idx];
                    selected.push({ ...stretch, category: 'Stretch' });

                    for (const [catName, catExercises] of Object.entries(exercisesData.stretches)) {
                        if (catExercises.some(e => e.id === stretch.id)) {
                            if (!usedCats.includes(catName)) {
                                usedCats.push(catName);
                            }
                        }
                    }

                    stretchCopy.splice(idx, 1);
                }

                setLastStretchCats(usedCats);
                saveStretchCategories(usedCats);

                setWorkout(selected);
                setCompletedWorkout([]);
                setLog({});
                setHardMode({});
                setWorkoutComplete(false);
            };

            const saveStretchCategories = async (cats) => {
                if (!user) return;

                const { data: existing } = await supabase
                    .from('stretch_categories')
                    .select('id')
                    .eq('user_id', user.id)
                    .single();

                if (existing) {
                    await supabase
                        .from('stretch_categories')
                        .update({ last_categories: cats, updated_at: new Date().toISOString() })
                        .eq('user_id', user.id);
                } else {
                    await supabase
                        .from('stretch_categories')
                        .insert({ user_id: user.id, last_categories: cats });
                }
            };

            const saveWorkoutToHistory = async () => {
                if (!user) return;

                try {
                    const d = new Date();
                    const workoutData = {
                        user_id: user.id,
                        date: d.toISOString().split('T')[0],
                        workout_type: dayName,
                        exercises: [...workout, ...completedWorkout].map(ex => {
                            const isHard = hardMode[ex.id];
                            const prefix = isHard ? 'hard' : 'reg';
                            const numSets = isHard ? ex.hardSets : ex.sets;
                            const loggedSets = [];

                            for (let i = 0; i < numSets; i++) {
                                loggedSets.push(log[`${ex.id}-${prefix}-${i}`] || '0');
                            }

                            return {
                                ...ex,
                                isHard: isHard,
                                loggedSets: loggedSets
                            };
                        })
                    };

                    const { data, error } = await supabase
                        .from('workout_history')
                        .insert(workoutData)
                        .select()
                        .single();

                    if (error) throw error;

                    const updatedHistory = [data, ...history];
                    setHistory(updatedHistory);
                    calculateStreak(updatedHistory, customRestDay);
                    setWorkoutComplete(true);
                } catch (error) {
                    console.error('Error saving workout:', error);
                }
            };

            const finishWorkout = () => {
                if (workout.length === 0 && completedWorkout.length > 0 && !workoutComplete) {
                    saveWorkoutToHistory();
                }
            };

            const toggleEx = async (category, id) => {
                const updated = JSON.parse(JSON.stringify(exercises));
                if (category === 'apt') {
                    const ex = updated.apt.find(e => e.id === id);
                    if (ex) ex.enabled = !ex.enabled;
                } else if (category === 'mandatory') {
                    const ex = updated.mandatory.find(e => e.id === id);
                    if (ex) ex.enabled = !ex.enabled;
                } else if (category === 'stretches') {
                    for (const subcat of Object.keys(updated.stretches)) {
                        const ex = updated.stretches[subcat].find(e => e.id === id);
                        if (ex) {
                            ex.enabled = !ex.enabled;
                            break;
                        }
                    }
                } else {
                    const ex = updated[category].find(e => e.id === id);
                    if (ex) ex.enabled = !ex.enabled;
                }

                setExercises(updated);
                await saveExerciseSettings(updated);
            };

            const saveExerciseSettings = async (exerciseData) => {
                if (!user) return;

                const { data: existing } = await supabase
                    .from('exercise_settings')
                    .select('id')
                    .eq('user_id', user.id)
                    .single();

                if (existing) {
                    await supabase
                        .from('exercise_settings')
                        .update({ exercise_data: exerciseData, updated_at: new Date().toISOString() })
                        .eq('user_id', user.id);
                } else {
                    await supabase
                        .from('exercise_settings')
                        .insert({ user_id: user.id, exercise_data: exerciseData });
                }
            };

            const logRep = (id, setIdx, value) => {
                setLog({ ...log, [`${id}-${setIdx}`]: value });
            };

            const toggleHardMode = (id) => {
                setHardMode({ ...hardMode, [id]: !hardMode[id] });
            };

            const isComplete = (ex) => {
                const isHard = hardMode[ex.id];
                const numSets = isHard ? ex.hardSets : ex.sets;
                const prefix = isHard ? 'hard' : 'reg';
                for (let i = 0; i < numSets; i++) {
                    if (!log[`${ex.id}-${prefix}-${i}`] || log[`${ex.id}-${prefix}-${i}`].trim() === '') {
                        return false;
                    }
                }
                return true;
            };

            const completeExercise = (ex) => {
                setWorkout(prev => prev.filter(e => e.id !== ex.id));
                setCompletedWorkout(prev => [...prev, ex]);
            };

            const viewDesc = (ex) => {
                setSelected(ex);
                setShowDesc(true);
            };

            const openVideo = (url) => {
                window.open(url, '_blank');
            };

            const postponeRestDay = async () => {
                if (!user) return;

                if (window.confirm('Move rest day to tomorrow? You can do today\'s workout instead.')) {
                    const today = new Date().toISOString().split('T')[0];

                    await supabase
                        .from('rest_day_postponements')
                        .insert({ user_id: user.id, postponed_date: today });

                    window.location.reload();
                }
            };

            const changeRestDay = async (day) => {
                if (!user) return;

                setCustomRestDay(day);

                await supabase
                    .from('user_profiles')
                    .update({ custom_rest_day: day, updated_at: new Date().toISOString() })
                    .eq('id', user.id);
            };

            const toggleCategory = (categoryKey) => {
                setCollapsedCategories(prev => ({
                    ...prev,
                    [categoryKey]: !prev[categoryKey]
                }));
            };

            const toggleAllInCategory = async (category, subcategory = null) => {
                const updated = JSON.parse(JSON.stringify(exercises));
                let exerciseList = [];

                if (category === 'stretches' && subcategory) {
                    exerciseList = updated.stretches[subcategory];
                } else {
                    exerciseList = updated[category];
                }

                const allEnabled = exerciseList.every(ex => ex.enabled);

                exerciseList.forEach(ex => {
                    ex.enabled = !allEnabled;
                });

                setExercises(updated);
                await saveExerciseSettings(updated);
            };

            const handleLogout = async () => {
                await supabase.auth.signOut();
                setUser(null);
            };

            if (loading) {
                return <div className="loading-screen">Loading...</div>;
            }

            if (!user) {
                return <AuthScreen />;
            }
            // Render modals and UI components
            const renderModals = () => (
                <>
                    {/* Settings Modal */}
                    <div className={`modal ${showSettings ? 'show' : ''}`}>
                        <div className="modal-content modal-full">
                            <div className="modal-header">
                                <div className="modal-title">Settings</div>
                                <button onClick={() => setShowSettings(false)} className="modal-done">Done</button>
                            </div>

                            <div className="tabs">
                                <button
                                    className={`tab ${activeSettingsTab === 'exercises' ? 'active' : ''}`}
                                    onClick={() => setActiveSettingsTab('exercises')}
                                >
                                    Exercises
                                </button>
                                <button
                                    className={`tab ${activeSettingsTab === 'restday' ? 'active' : ''}`}
                                    onClick={() => setActiveSettingsTab('restday')}
                                >
                                    Rest Day
                                </button>
                                <button
                                    className={`tab ${activeSettingsTab === 'about' ? 'active' : ''}`}
                                    onClick={() => setActiveSettingsTab('about')}
                                >
                                    About
                                </button>
                            </div>

                            <div className="modal-scroll">
                                {/* Exercises Tab */}
                                <div className={`tab-content ${activeSettingsTab === 'exercises' ? 'active' : ''}`}>
                                    {/* Mandatory Mobility */}
                                    <div className="category-header" onClick={() => toggleCategory('mandatory')}>
                                        <div className="category-title-wrapper">
                                            <span className={`category-arrow ${collapsedCategories['mandatory'] ? 'collapsed' : ''}`}>â–¼</span>
                                            <div className="cat-title" style={{ marginTop: 0, marginBottom: 0 }}>Mandatory Mobility (3x per week)</div>
                                        </div>
                                        <button
                                            className="toggle-all-btn"
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                toggleAllInCategory('mandatory');
                                            }}
                                        >
                                            Toggle All
                                        </button>
                                    </div>
                                    <div className="settings-subtitle">These exercises automatically appear Mon/Wed/Fri</div>
                                    <div className={`category-exercises ${collapsedCategories['mandatory'] ? 'collapsed' : ''}`}>
                                        {exercises.mandatory.map(ex => (
                                            <div key={ex.id} className="settings-row">
                                                <div className="settings-name">{ex.name}</div>
                                                <input
                                                    type="checkbox"
                                                    className="checkbox"
                                                    checked={ex.enabled}
                                                    onChange={() => toggleEx('mandatory', ex.id)}
                                                />
                                            </div>
                                        ))}
                                    </div>

                                    {/* Push Exercises */}
                                    <div className="category-header" onClick={() => toggleCategory('push')}>
                                        <div className="category-title-wrapper">
                                            <span className={`category-arrow ${collapsedCategories['push'] ? 'collapsed' : ''}`}>â–¼</span>
                                            <div className="cat-title" style={{ marginTop: 0, marginBottom: 0 }}>Push Exercises</div>
                                        </div>
                                        <button
                                            className="toggle-all-btn"
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                toggleAllInCategory('push');
                                            }}
                                        >
                                            Toggle All
                                        </button>
                                    </div>
                                    <div className={`category-exercises ${collapsedCategories['push'] ? 'collapsed' : ''}`}>
                                        {exercises.push.map(ex => (
                                            <div key={ex.id} className="settings-row">
                                                <div className="settings-name">{ex.name}</div>
                                                <input
                                                    type="checkbox"
                                                    className="checkbox"
                                                    checked={ex.enabled}
                                                    onChange={() => toggleEx('push', ex.id)}
                                                />
                                            </div>
                                        ))}
                                    </div>

                                    {/* Pull Exercises */}
                                    <div className="category-header" onClick={() => toggleCategory('pull')}>
                                        <div className="category-title-wrapper">
                                            <span className={`category-arrow ${collapsedCategories['pull'] ? 'collapsed' : ''}`}>â–¼</span>
                                            <div className="cat-title" style={{ marginTop: 0, marginBottom: 0 }}>Pull Exercises</div>
                                        </div>
                                        <button
                                            className="toggle-all-btn"
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                toggleAllInCategory('pull');
                                            }}
                                        >
                                            Toggle All
                                        </button>
                                    </div>
                                    <div className={`category-exercises ${collapsedCategories['pull'] ? 'collapsed' : ''}`}>
                                        {exercises.pull.map(ex => (
                                            <div key={ex.id} className="settings-row">
                                                <div className="settings-name">{ex.name}</div>
                                                <input
                                                    type="checkbox"
                                                    className="checkbox"
                                                    checked={ex.enabled}
                                                    onChange={() => toggleEx('pull', ex.id)}
                                                />
                                            </div>
                                        ))}
                                    </div>

                                    {/* Squats */}
                                    <div className="category-header" onClick={() => toggleCategory('squats')}>
                                        <div className="category-title-wrapper">
                                            <span className={`category-arrow ${collapsedCategories['squats'] ? 'collapsed' : ''}`}>â–¼</span>
                                            <div className="cat-title" style={{ marginTop: 0, marginBottom: 0 }}>Squats</div>
                                        </div>
                                        <button
                                            className="toggle-all-btn"
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                toggleAllInCategory('squats');
                                            }}
                                        >
                                            Toggle All
                                        </button>
                                    </div>
                                    <div className={`category-exercises ${collapsedCategories['squats'] ? 'collapsed' : ''}`}>
                                        {exercises.squats.map(ex => (
                                            <div key={ex.id} className="settings-row">
                                                <div className="settings-name">{ex.name}</div>
                                                <input
                                                    type="checkbox"
                                                    className="checkbox"
                                                    checked={ex.enabled}
                                                    onChange={() => toggleEx('squats', ex.id)}
                                                />
                                            </div>
                                        ))}
                                    </div>

                                    {/* Core */}
                                    <div className="category-header" onClick={() => toggleCategory('core')}>
                                        <div className="category-title-wrapper">
                                            <span className={`category-arrow ${collapsedCategories['core'] ? 'collapsed' : ''}`}>â–¼</span>
                                            <div className="cat-title" style={{ marginTop: 0, marginBottom: 0 }}>Core</div>
                                        </div>
                                        <button
                                            className="toggle-all-btn"
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                toggleAllInCategory('core');
                                            }}
                                        >
                                            Toggle All
                                        </button>
                                    </div>
                                    <div className={`category-exercises ${collapsedCategories['core'] ? 'collapsed' : ''}`}>
                                        {exercises.core.map(ex => (
                                            <div key={ex.id} className="settings-row">
                                                <div className="settings-name">{ex.name}</div>
                                                <input
                                                    type="checkbox"
                                                    className="checkbox"
                                                    checked={ex.enabled}
                                                    onChange={() => toggleEx('core', ex.id)}
                                                />
                                            </div>
                                        ))}
                                    </div>

                                    {/* APT */}
                                    <div className="category-header" onClick={() => toggleCategory('apt')}>
                                        <div className="category-title-wrapper">
                                            <span className={`category-arrow ${collapsedCategories['apt'] ? 'collapsed' : ''}`}>â–¼</span>
                                            <div className="cat-title" style={{ marginTop: 0, marginBottom: 0 }}>APT</div>
                                        </div>
                                        <button
                                            className="toggle-all-btn"
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                toggleAllInCategory('apt');
                                            }}
                                        >
                                            Toggle All
                                        </button>
                                    </div>
                                    <div className={`category-exercises ${collapsedCategories['apt'] ? 'collapsed' : ''}`}>
                                        {exercises.apt.map(ex => (
                                            <div key={ex.id} className="settings-row">
                                                <div className="settings-name">{ex.name}</div>
                                                <input
                                                    type="checkbox"
                                                    className="checkbox"
                                                    checked={ex.enabled}
                                                    onChange={() => toggleEx('apt', ex.id)}
                                                />
                                            </div>
                                        ))}
                                    </div>

                                    {/* Hip Flexor Stretches */}
                                    <div className="category-header" onClick={() => toggleCategory('hipFlexor')}>
                                        <div className="category-title-wrapper">
                                            <span className={`category-arrow ${collapsedCategories['hipFlexor'] ? 'collapsed' : ''}`}>â–¼</span>
                                            <div className="cat-title" style={{ marginTop: 0, marginBottom: 0 }}>Hip Flexor Stretches</div>
                                        </div>
                                        <button
                                            className="toggle-all-btn"
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                toggleAllInCategory('stretches', 'hipFlexor');
                                            }}
                                        >
                                            Toggle All
                                        </button>
                                    </div>
                                    <div className={`category-exercises ${collapsedCategories['hipFlexor'] ? 'collapsed' : ''}`}>
                                        {exercises.stretches.hipFlexor.map(ex => (
                                            <div key={ex.id} className="settings-row">
                                                <div className="settings-name">{ex.name}</div>
                                                <input
                                                    type="checkbox"
                                                    className="checkbox"
                                                    checked={ex.enabled}
                                                    onChange={() => toggleEx('stretches', ex.id)}
                                                />
                                            </div>
                                        ))}
                                    </div>

                                    {/* Hamstring Stretches */}
                                    <div className="category-header" onClick={() => toggleCategory('hamstring')}>
                                        <div className="category-title-wrapper">
                                            <span className={`category-arrow ${collapsedCategories['hamstring'] ? 'collapsed' : ''}`}>â–¼</span>
                                            <div className="cat-title" style={{ marginTop: 0, marginBottom: 0 }}>Hamstring Stretches</div>
                                        </div>
                                        <button
                                            className="toggle-all-btn"
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                toggleAllInCategory('stretches', 'hamstring');
                                            }}
                                        >
                                            Toggle All
                                        </button>
                                    </div>
                                    <div className={`category-exercises ${collapsedCategories['hamstring'] ? 'collapsed' : ''}`}>
                                        {exercises.stretches.hamstring.map(ex => (
                                            <div key={ex.id} className="settings-row">
                                                <div className="settings-name">{ex.name}</div>
                                                <input
                                                    type="checkbox"
                                                    className="checkbox"
                                                    checked={ex.enabled}
                                                    onChange={() => toggleEx('stretches', ex.id)}
                                                />
                                            </div>
                                        ))}
                                    </div>

                                    {/* Hip/Glute Stretches */}
                                    <div className="category-header" onClick={() => toggleCategory('hipGlute')}>
                                        <div className="category-title-wrapper">
                                            <span className={`category-arrow ${collapsedCategories['hipGlute'] ? 'collapsed' : ''}`}>â–¼</span>
                                            <div className="cat-title" style={{ marginTop: 0, marginBottom: 0 }}>Hip/Glute Stretches</div>
                                        </div>
                                        <button
                                            className="toggle-all-btn"
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                toggleAllInCategory('stretches', 'hipGlute');
                                            }}
                                        >
                                            Toggle All
                                        </button>
                                    </div>
                                    <div className={`category-exercises ${collapsedCategories['hipGlute'] ? 'collapsed' : ''}`}>
                                        {exercises.stretches.hipGlute.map(ex => (
                                            <div key={ex.id} className="settings-row">
                                                <div className="settings-name">{ex.name}</div>
                                                <input
                                                    type="checkbox"
                                                    className="checkbox"
                                                    checked={ex.enabled}
                                                    onChange={() => toggleEx('stretches', ex.id)}
                                                />
                                            </div>
                                        ))}
                                    </div>

                                    {/* Shoulder Stretches */}
                                    <div className="category-header" onClick={() => toggleCategory('shoulder')}>
                                        <div className="category-title-wrapper">
                                            <span className={`category-arrow ${collapsedCategories['shoulder'] ? 'collapsed' : ''}`}>â–¼</span>
                                            <div className="cat-title" style={{ marginTop: 0, marginBottom: 0 }}>Shoulder Stretches</div>
                                        </div>
                                        <button
                                            className="toggle-all-btn"
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                toggleAllInCategory('stretches', 'shoulder');
                                            }}
                                        >
                                            Toggle All
                                        </button>
                                    </div>
                                    <div className={`category-exercises ${collapsedCategories['shoulder'] ? 'collapsed' : ''}`}>
                                        {exercises.stretches.shoulder.map(ex => (
                                            <div key={ex.id} className="settings-row">
                                                <div className="settings-name">{ex.name}</div>
                                                <input
                                                    type="checkbox"
                                                    className="checkbox"
                                                    checked={ex.enabled}
                                                    onChange={() => toggleEx('stretches', ex.id)}
                                                />
                                            </div>
                                        ))}
                                    </div>

                                    {/* Back/Spine Stretches */}
                                    <div className="category-header" onClick={() => toggleCategory('backSpine')}>
                                        <div className="category-title-wrapper">
                                            <span className={`category-arrow ${collapsedCategories['backSpine'] ? 'collapsed' : ''}`}>â–¼</span>
                                            <div className="cat-title" style={{ marginTop: 0, marginBottom: 0 }}>Back/Spine Stretches</div>
                                        </div>
                                        <button
                                            className="toggle-all-btn"
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                toggleAllInCategory('stretches', 'backSpine');
                                            }}
                                        >
                                            Toggle All
                                        </button>
                                    </div>
                                    <div className={`category-exercises ${collapsedCategories['backSpine'] ? 'collapsed' : ''}`}>
                                        {exercises.stretches.backSpine.map(ex => (
                                            <div key={ex.id} className="settings-row">
                                                <div className="settings-name">{ex.name}</div>
                                                <input
                                                    type="checkbox"
                                                    className="checkbox"
                                                    checked={ex.enabled}
                                                    onChange={() => toggleEx('stretches', ex.id)}
                                                />
                                            </div>
                                        ))}
                                    </div>

                                    {/* Full Body Stretches */}
                                    <div className="category-header" onClick={() => toggleCategory('fullBody')}>
                                        <div className="category-title-wrapper">
                                            <span className={`category-arrow ${collapsedCategories['fullBody'] ? 'collapsed' : ''}`}>â–¼</span>
                                            <div className="cat-title" style={{ marginTop: 0, marginBottom: 0 }}>Full Body Stretches</div>
                                        </div>
                                        <button
                                            className="toggle-all-btn"
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                toggleAllInCategory('stretches', 'fullBody');
                                            }}
                                        >
                                            Toggle All
                                        </button>
                                    </div>
                                    <div className={`category-exercises ${collapsedCategories['fullBody'] ? 'collapsed' : ''}`}>
                                        {exercises.stretches.fullBody.map(ex => (
                                            <div key={ex.id} className="settings-row">
                                                <div className="settings-name">{ex.name}</div>
                                                <input
                                                    type="checkbox"
                                                    className="checkbox"
                                                    checked={ex.enabled}
                                                    onChange={() => toggleEx('stretches', ex.id)}
                                                />
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* Rest Day Tab */}
                                <div className={`tab-content ${activeSettingsTab === 'restday' ? 'active' : ''}`}>
                                    <div className="info-section">
                                        <div className="info-title">Rest Day Configuration</div>
                                        <div className="info-text">
                                            Choose which day of the week should be your rest day. You can also postpone rest day by one day using the "Postpone Rest" button on rest days.
                                        </div>
                                    </div>

                                    <div className="rest-day-selector">
                                        <div className="rest-day-label">Select Rest Day:</div>
                                        <div className="rest-day-options">
                                            {DAYS_OF_WEEK.map((day, idx) => (
                                                <div
                                                    key={idx}
                                                    className={`rest-day-option ${customRestDay === idx ? 'selected' : ''}`}
                                                    onClick={() => changeRestDay(idx)}
                                                >
                                                    {day}
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    <div className="info-section" style={{ marginTop: '20px' }}>
                                        <div className="info-title">Current Schedule</div>
                                        <div className="info-text">
                                            {DAYS_OF_WEEK.map((day, idx) => {
                                                if (idx === customRestDay) {
                                                    return <div key={idx}><strong>{day}:</strong> Rest Day ðŸ’¤</div>;
                                                } else {
                                                    return <div key={idx}><strong>{day}:</strong> {WEEK_SCHEDULE[idx].name} Day ðŸ’ª</div>;
                                                }
                                            })}
                                        </div>
                                    </div>
                                </div>

                                {/* About Tab */}
                                <div className={`tab-content ${activeSettingsTab === 'about' ? 'active' : ''}`}>
                                    <div className="info-section">
                                        <div className="info-title">Workout Tracker</div>
                                        <div className="info-text">
                                            A progressive workout tracker with automatic daily workout generation based on a Push/Pull/Legs split schedule. Now with cloud sync!
                                        </div>
                                    </div>

                                    <div className="info-section">
                                        <div className="info-title">Features</div>
                                        <div className="info-text">
                                            â€¢ Cloud-synced data across all devices<br />
                                            â€¢ Secure user authentication<br />
                                            â€¢ Automatic daily workout generation<br />
                                            â€¢ Regular and Hard mode for each exercise<br />
                                            â€¢ Workout history and streak tracking<br />
                                            â€¢ Customizable exercise selection<br />
                                            â€¢ Configurable rest days<br />
                                            â€¢ APT correction exercises<br />
                                            â€¢ Mandatory mobility work (3x/week)<br />
                                            â€¢ Progressive overload tracking
                                        </div>
                                    </div>

                                    <div className="info-section">
                                        <div className="info-title">How It Works</div>
                                        <div className="info-text">
                                            Each day, the app generates a workout based on your schedule. Complete all sets and reps, then mark exercises as complete. Your workout history and streak are automatically tracked and synced to the cloud.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* History Modal */}
                    <div className={`modal ${showHistory ? 'show' : ''}`}>
                        <div className="modal-content modal-full">
                            <div className="modal-header">
                                <div className="modal-title">Workout History</div>
                                <button onClick={() => setShowHistory(false)} className="modal-done">Done</button>
                            </div>
                            <div className="modal-scroll">
                                {history.length === 0 && <div className="empty-history">No workout history yet. Complete your first workout!</div>}
                                {history.map((h, idx) => (
                                    <div key={idx} className="history-card" onClick={() => {
                                        setViewingHistoryWorkout(h);
                                        setShowHistoryDetail(true);
                                        setShowHistory(false);
                                    }}>
                                        <div className="history-date">{new Date(h.date).toLocaleDateString()}</div>
                                        <div className="history-type">{h.workout_type} Day</div>
                                        <div className="history-exercises">
                                            {h.exercises.length} exercises completed
                                        </div>
                                        <div className="tap-to-view">Tap to view details</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* History Detail Modal */}
                    <div className={`modal ${showHistoryDetail ? 'show' : ''}`}>
                        <div className="modal-content modal-full">
                            <div className="modal-header">
                                <div className="modal-title">Workout Details</div>
                                <button onClick={() => {
                                    setShowHistoryDetail(false);
                                    setShowHistory(true);
                                }} className="modal-done">Back</button>
                            </div>
                            <div className="modal-scroll">
                                {viewingHistoryWorkout && (
                                    <>
                                        <div className="info-section">
                                            <div className="info-title">{new Date(viewingHistoryWorkout.date).toLocaleDateString()}</div>
                                            <div className="info-text">{viewingHistoryWorkout.workout_type} Day</div>
                                        </div>

                                        {viewingHistoryWorkout.exercises.map((ex, idx) => (
                                            <div key={idx} className="card completed-card">
                                                <div className="card-header">
                                                    <div className="ex-info">
                                                        <div className="ex-name">{ex.name}</div>
                                                        <div className="ex-cat">{ex.category}</div>
                                                    </div>
                                                </div>

                                                <div className={ex.isHard ? 'hard-section' : 'reg-section'}>
                                                    <div className={ex.isHard ? 'diff-title-hard' : 'diff-title'}>
                                                        {ex.isHard ? 'Hard Mode' : 'Regular Mode'}
                                                    </div>
                                                    {ex.loggedSets.map((value, setIdx) => (
                                                        <div key={setIdx} className="set-row">
                                                            <div className="set-label">Set {setIdx + 1}:</div>
                                                            <div className="completed-set-value">
                                                                {value} {ex.isTime ? 'seconds' : 'reps'}
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Description Modal */}
                    <div className={`modal ${showDesc ? 'show' : ''}`} onClick={() => setShowDesc(false)}>
                        <div className="desc-modal-content" onClick={(e) => e.stopPropagation()}>
                            {selected && (
                                <>
                                    <div className="desc-title">{selected.name}</div>
                                    <div className="desc-text">{selected.desc}</div>
                                    {selected.videoUrl && (
                                        <button onClick={() => openVideo(selected.videoUrl)} className="video-link-btn">
                                            Watch Video Tutorial
                                        </button>
                                    )}
                                    {selected.pdfUrl && (
                                        <>
                                            <div className="pdf-info-box">
                                                <div className="pdf-info-text">Movement by David Stretching Program</div>
                                                {selected.pdfPage && (
                                                    <div className="pdf-page-text">See: {selected.pdfPage}</div>
                                                )}
                                            </div>
                                            <button onClick={() => openVideo(selected.pdfUrl)} className="pdf-link-btn">
                                                Open PDF Guide
                                            </button>
                                        </>
                                    )}
                                    <button onClick={() => setShowDesc(false)} className="close-btn">Close</button>
                                </>
                            )}
                        </div>
                    </div>
                </>
            );

            // Rest Day View
            if (isRest) {
                return (
                    <div className="container">
                        <div className="header">
                            <div className="header-title">Rest Day</div>
                            <div className="header-date">{date}</div>
                            <div className="user-email">{user.email}</div>
                            <div className="streak">Streak: {streak} days</div>
                        </div>

                        <div className="button-row">
                            <button onClick={() => setShowSettings(true)} className="btn settings-btn">Settings</button>
                            <button onClick={() => setShowHistory(true)} className="btn history-btn">History</button>
                            <button onClick={postponeRestDay} className="btn postpone-btn">Postpone Rest</button>
                            <button onClick={handleLogout} className="btn logout-btn">Logout</button>
                        </div>

                        <div className="rest-container">
                            <div className="rest-title">{DAYS_OF_WEEK[new Date().getDay()]} Rest Day</div>
                            <div className="rest-text">Recovery is when you get stronger. Rest up for tomorrow!</div>
                        </div>

                        {renderModals()}
                    </div>
                );
            }

            // Workout Complete View
            if (workoutComplete) {
                return (
                    <div className="container">
                        <div className="header">
                            <div className="header-title">{dayName} Day</div>
                            <div className="header-date">{date}</div>
                            <div className="user-email">{user.email}</div>
                            <div className="streak">Streak: {streak} days ðŸ”¥</div>
                        </div>

                        <div className="button-row">
                            <button onClick={() => setShowSettings(true)} className="btn settings-btn">Settings</button>
                            <button onClick={() => setShowHistory(true)} className="btn history-btn">History</button>
                            <button onClick={handleLogout} className="btn logout-btn">Logout</button>
                        </div>

                        <div className="rest-container">
                            <div className="rest-title">Workout Complete! ðŸ’ª</div>
                            <div className="rest-text">Great job! You've already completed today's workout.</div>
                        </div>

                        {renderModals()}
                    </div>
                );
            }

            // Main Workout View
            return (
                <div className="container">
                    <div className="header">
                        <div className="header-title">{dayName} Day</div>
                        <div className="header-date">{date}</div>
                        <div className="user-email">{user.email}</div>
                        <div className="streak">Streak: {streak} days ðŸ”¥</div>
                        <button onClick={() => generateWorkout(new Date().getDay())} className="refresh-btn">
                            ðŸ”„
                        </button>
                    </div>

                    <div className="button-row">
                        <button onClick={() => setShowSettings(true)} className="btn settings-btn">Settings</button>
                        <button onClick={() => setShowHistory(true)} className="btn history-btn">History</button>
                        <button onClick={handleLogout} className="btn logout-btn">Logout</button>
                    </div>

                    <div className="workout-list">
                        {workout.map(ex => (
                            <div key={ex.id} className="card">
                                <div className="card-header">
                                    <div className="ex-info">
                                        <div className="ex-name">{ex.name}</div>
                                        <div className="ex-cat">{ex.category}</div>
                                    </div>
                                    <div className="header-right">
                                        <div className="diff-toggle">
                                            <span className={`diff-label ${!hardMode[ex.id] ? 'diff-label-active' : ''}`}>
                                                Reg
                                            </span>
                                            <div
                                                className={`toggle-switch ${hardMode[ex.id] ? 'hard' : ''}`}
                                                onClick={() => toggleHardMode(ex.id)}
                                            ></div>
                                            <span className={`diff-label ${hardMode[ex.id] ? 'diff-label-active' : ''}`}>
                                                Hard
                                            </span>
                                        </div>
                                        <button onClick={() => viewDesc(ex)} className="desc-btn">
                                            View Details
                                        </button>
                                    </div>
                                </div>

                                {!hardMode[ex.id] && (
                                    <div className="reg-section">
                                        <div className="diff-title">Regular Mode: {ex.sets} sets Ã— {ex.reps} {ex.isTime ? 'seconds' : 'reps'}</div>
                                        {Array.from({ length: ex.sets }).map((_, i) => (
                                            <div key={i} className="set-row">
                                                <div className="set-label">Set {i + 1}:</div>
                                                <input
                                                    type="number"
                                                    className="input"
                                                    placeholder={ex.isTime ? 'Seconds' : 'Reps'}
                                                    value={log[`${ex.id}-reg-${i}`] || ''}
                                                    onChange={(e) => logRep(ex.id, `reg-${i}`, e.target.value)}
                                                />
                                            </div>
                                        ))}
                                    </div>
                                )}

                                {hardMode[ex.id] && (
                                    <div className="hard-section">
                                        <div className="diff-title-hard">Hard Mode: {ex.hardSets} sets Ã— {ex.hardReps} {ex.isTime ? 'seconds' : 'reps'}</div>
                                        {Array.from({ length: ex.hardSets }).map((_, i) => (
                                            <div key={i} className="set-row">
                                                <div className="set-label">Set {i + 1}:</div>
                                                <input
                                                    type="number"
                                                    className="input"
                                                    placeholder={ex.isTime ? 'Seconds' : 'Reps'}
                                                    value={log[`${ex.id}-hard-${i}`] || ''}
                                                    onChange={(e) => logRep(ex.id, `hard-${i}`, e.target.value)}
                                                />
                                            </div>
                                        ))}
                                    </div>
                                )}

                                <button
                                    className="complete-btn"
                                    disabled={!isComplete(ex)}
                                    onClick={() => completeExercise(ex)}
                                >
                                    {isComplete(ex) ? 'Complete Exercise' : 'Fill All Sets'}
                                </button>
                            </div>
                        ))}

                        {completedWorkout.length > 0 && (
                            <>
                                <div className="completed-divider">
                                    <div className="completed-title">Completed Exercises</div>
                                    <div className="completed-summary">
                                        {completedWorkout.length} of {workout.length + completedWorkout.length} complete
                                    </div>
                                </div>

                                {completedWorkout.map(ex => {
                                    const isHard = hardMode[ex.id];
                                    const numSets = isHard ? ex.hardSets : ex.sets;
                                    const prefix = isHard ? 'hard' : 'reg';

                                    return (
                                        <div key={ex.id} className="card completed-card">
                                            <div className="card-header">
                                                <div className="ex-info">
                                                    <div className="ex-name completed-text">{ex.name}</div>
                                                    <div className="ex-cat">{ex.category}</div>
                                                </div>
                                            </div>

                                            <div className={isHard ? 'hard-section' : 'reg-section'}>
                                                <div className={isHard ? 'diff-title-hard' : 'diff-title'}>
                                                    {isHard ? 'Hard Mode' : 'Regular Mode'}
                                                </div>
                                                {Array.from({ length: numSets }).map((_, i) => (
                                                    <div key={i} className="set-row">
                                                        <div className="set-label">Set {i + 1}:</div>
                                                        <div className="completed-set-value">
                                                            {log[`${ex.id}-${prefix}-${i}`]} {ex.isTime ? 'seconds' : 'reps'}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    );
                                })}
                            </>
                        )}
                    </div>

                    {renderModals()}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>

</html>